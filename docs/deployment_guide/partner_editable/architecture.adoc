:xrefstyle: short

Deploy this Partner Solution with default parameters to build the following {partner-product-short-name} environment in the AWS Cloud.

// Replace this example diagram with your own. Follow our wiki guidelines: https://w.amazon.com/bin/view/AWS_Quick_Starts/Process_for_PSAs/#HPrepareyourarchitecturediagram. Upload your source PowerPoint file to the GitHub {deployment name}/docs/images/ directory in its repository.

=== Architecture diagram

:xrefstyle: short
[#architecture1]
.Partner Solution architecture for {partner-product-short-name} on AWS
image::../docs/deployment_guide/images/architecture_diagram.png[Architecture]

.Key to architecture and best practice compliance tags
[cols="^1,7"]
|===
|Tag|Meaning

|^[AWS-WA]^|Compliant with **AWS W**ell **A**rchitected - including favoring platform&#8209;as&#8209;a&#8209;service (PaaS) to externalize scaling and availability management and high&#8209;availability (HA) / self&#8209;healing for non&#8209;PaaS resources.
|^[GL-RAR]^|Compliant with a **G**it**L**ab **R**eference **A**rchitecture **R**equirement or **R**ecommendation - only applied to items where the reference architectures are opinionated.
|===

This automation results in a completely operational {partner-product-short-name} instance.

As shown in <<architecture1>>, the Partner Solution sets up the following:

* A highly available architecture that spans two or three Availability Zones. ^[AWS-WA]^
* A virtual private cloud (VPC) configured with public and private subnets, according to AWS best practices, to provide you with your own virtual network on AWS.^1^ ^[AWS-WA]^
* In the public subnets:
** Managed network address translation (NAT) gateways to allow outbound internet access for resources in the private subnets.^1^
** In one public subnet, a Linux bastion host in an Auto Scaling group to allow inbound Secure Shell (SSH) access to Amazon Elastic Compute Cloud (Amazon EC2) instances in private subnets. The bastion host is also configured with the Kubernetes `kubectl` command line interface (CLI) and the `helm` CLI for managing the Kubernetes cluster as well as the AWS CLI for general AWS management. ^[AWS-WA]^
* In the private subnets:
** An Auto Scaling group of Amazon Elastic Compute Cloud (Amazon EC2) Kubernetes nodes.^2^ ^[AWS-WA]^
** An Amazon Elastic Kubernetes Service (Amazon EKS) cluster, which creates the Kubernetes control plane.
** An Amazon Relational Database Service (Amazon RDS) cluster for {partner-product-short-name} and Praefect databases. ^[GL-RAR][AWS-WA]^
** An Amazon ElastiCache: Redis cluster for caching. ^[GL-RAR][AWS-WA]^
** A Praefect node Auto Scaling group spread across Availability Zones. https://docs.gitlab.com/ee/administration/reference_architectures/10k_users.html#cloud-native-hybrid-reference-architecture-with-helm-charts-alternative[{partner-product-short-name}'s Cloud Native Hybrid reference architecture with Helm Charts (alternative)^] calls for Praefect to be implemented on Amazon EC2 instance compute. ^[GL-RAR][AWS-WA]^
** An Auto Scaling group with Gitaly nodes spread across Availability Zones. {partner-product-short-name}'s Cloud Native Hybrid reference architecture^] calls for Gitaly to be implemented on Amazon EC2 instance compute and to utilize non-Network File System (NFS) storage for the file system containing Git repositories. ^[GL-RAR][AWS-WA]^
* AWS Secrets Manager for securely storing credentials.
* Multiple Amazon Simple Storage Service (Amazon S3) buckets for platform-as-a-service (PaaS) of non-Git file systems and Git Large File Storage (LFS) systems. ^[GL-RAR][AWS-WA]^. For more information, refer to <<Object storage for {partner-product-short-name} storage types>>. ^[GL-RAR][AWS-WA]^
* An Amazon Route 53 hosted zone for Domain Name System (DNS) name resolution. ^[AWS-WA]^
* An AWS Certificate Manager (ACM) for TLS traffic encryption. ^[AWS-WA]^
* An Amazon Simple Email Service (Amazon SES) domain for outgoing email messages. ^[AWS-WA]^
* Amazon CloudWatch Container Insights integration and agent for instance compute. ^[AWS-WA]^
* AWS Systems Manager parameter store for storing infrastructure as code (IaC) parameters and outputs. ^[AWS-WA]^
* Elastic Load Balancing (ELB) for external access and internal load balancing requests. ^[AWS-WA]^

[.small]#^1^The template that deploys the Partner Solution into an existing VPC skips the components and prompts you for your existing VPC configuration.#

[.small]#^2^The template that deploys the Partner Solution into an existing EKS cluster skips the components and prompts you for your existing EKS configuration.#

=== Bundling

==== Bundled provisioning of container registry, backup, log aggregation, and monitoring

- Uses Amazon Linux 2 throughout and benefits from Amazon-specific optimizations for performance and compute density for both EKS and EC2 hosts. ^[AWS-WA]^
- All {partner-product-short-name} logs are automatically aggregated into CloudWatch logs with CloudWatch Instance Agent and CloudWatch Container Insights. ^[AWS-WA]^
- EKS workload monitoring with CloudWatch Container Insights. ^[AWS-WA]^
- Preconfigured {partner-product-short-name} backup.
- Prometheus is always deployed.
- The container registry is automatically setup at `registry.[subdomain]`. ^[AWS-WA]^

=== Security

==== Application secrets

** Stores generated secrets in AWS Secrets Manager (example: generates a proper initial root password). ^[AWS-WA]^

==== Amazon EKS cluster administration

The {partner-product-short-name} Kubernetes endpoint can be private, but a bastion host must be deployed to do direct cluster management (preloaded with AWS, EKS and Kubernetes management utilities, and IAM permissions for cluster management). The bastion host is setup with SSH keys, but can also be accessed more securely using AWS Systems Manager (SSM) Session Manager. Additionally, the bastion host has command audit logging enabled, and the log is uploaded to CloudWatch Logs.

==== Data encryption

* Data in Transit:
** SSL for front end HTTP. ^[AWS-WA]^
** SSL for {partner-product-short-name} to Amazon S3. ^[AWS-WA]^
** SSL for {partner-product-short-name} to Amazon RDS: PostgreSQL. ^[AWS-WA]^
** SSL for {partner-product-short-name} to Amazon ElastiCache: Redis. ^[AWS-WA]^
** SSL for {partner-product-short-name} to Runner. ^[AWS-WA]^
** SSL not yet available for {partner-product-short-name} to Praefect to Gitaly. ^[AWS-WA]^
* Data at rest (AWS managed keys):
** Amazon S3 Server&#8209;Side encryption. ^[AWS-WA]^
** Amazon RDS: PostgreSQL encryption. ^[AWS-WA]^
** Amazon ElastiCache: Redis encryption. ^[AWS-WA]^
** Amazon Elastic Block Store (Amazon EBS) encryption. ^[AWS-WA]^

=== Database

The {partner-product-short-name} Partner Solution deploys a highly available (HA) PostgreSQL database cluster using the https://aws.amazon.com/quickstart/architecture/aurora-postgresql/[Modular Architecture for Amazon Aurora PostgreSQL Partner Solution^].

Consider adjusting database instance size using the *DBInstanceClass* parameter, depending on the projected size of your {partner-product-short-name} deployment.

These two databases are deployed to the same cluster:

* {partner-product-short-name} database.
* Praefect tracking database: requires a separate tracking database as described in https://docs.gitlab.com/ee/administration/gitaly/praefect.html[Configure Gitaly Cluster^]. 

For more information, refer to https://docs.gitlab.com/charts/advanced/external-db/[Configure the {partner-product-short-name} chart with an external database^].

=== Storage

==== Git repository storage

* Amazon EBS volumes on Gitaly cluster instances. ^[GL-RAR]^

==== Object storage for {partner-product-short-name} storage types

This Partner Solution creates Amazon S3 buckets for the following use cases:

* Artifacts
* https://git-lfs.github.com/[Git Large File Storage (git-lfs)]
* Uploads
* Packages
* Terraform
* Pseudonymizer
* Registry
* Backup
* Backup temp

Apply S3 policies to these buckets to manage retention, storage tier, and replication.

By default, the contents of each bucket is encrypted with Amazon S3 server&#8209;side encryption (SSE-S3). The name of each bucket is auto&#8209;generated and exported as SSM parameters (see the <<Exports>> section).

For more information, refer to https://docs.gitlab.com/charts/advanced/external-object-storage/[Configure the {partner-product-short-name} chart with an external object storage^].

=== Backups

Backups include {partner-product-short-name} database snapshots and the contents of {partner-product-short-name} projects, such as Git repositories and wiki pages. For the following reasons, backups do not include the contents of Amazon S3 buckets (see object storage for a list of buckets):

* Contents of these buckets may be very large (pipeline artifacts or Docker images) and that may affect stability and performance of the backup jobs.
* Amazon S3 is a https://aws.amazon.com/s3/faqs/#Durability_.26_Data_Protection[durable storage^] option.
* Amazon S3 storage policies also enable out-of-Region replication and management of storage class migration to control costs for older data.

==== Schedule backups

A cron expression controls the backup schedule and the default value is `pass:[0 1 * * * *]` (daily at 1:00 AM). Set a different schedule using the *BackupSchedule* parameter.

==== Backup and restore resources

NOTE: The disk volume required for backups is 2x larger than the backup tarball, so ensure you download all resources first and package to a tarball file (stored locally). Consider the size of your {partner-product-short-name} database and projects (mainly Git repositories) to set the size of the underlying EBS volumes appropriately, using *BackupVolumeSize* parameter.

In testing, the average size of backups for the default configuration were 20 GB, and it took 30 minutes to create and upload to the Amazon S3 bucket.

For large {partner-product-short-name} deployments, use *BackupCpu* and *BackupMemory* parameters to adjust the CPU and memory requirements for backup and restore pods.

For more information, refer to "Backup and restore a {partner-product-short-name} instance".

=== Telemetry and monitoring

==== Amazon CloudWatch Container Insights

To collect, aggregate, and summarize metrics & logs, set the *ConfigureContainerInsights* parameter to `Yes` to integrate this Partner Solution to the Amazon EKS cluster with https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/ContainerInsights.html[Amazon CloudWatch Container Insights^].

Access these logs and metrics from the Amazon CloudWatch console, as shown in <<cloudwatch-container-insights>>:

:xrefstyle: short
[#cloudwatch-container-insights]
.Amazon CloudWatch container insights
image::../docs/deployment_guide/images/cloudwatch-container-insights.png[Amazon CloudWatch Container Insights]

==== Prometheus metrics

{partner-product-short-name} exposes Prometheus metrics under `/-/metrics` of the {partner-product-short-name} Ingress, as shown in <<grafana>>. You can also set the *ConfigureGrafana* parameter to `Yes` to enable a Grafana integration.

:xrefstyle: short
[#grafana]
.Grafana
image::../docs/deployment_guide/images/grafana.png[Grafana]

For more information, refer to https://docs.gitlab.com/charts/charts/globals.html#configure-grafana-integration[Configure Grafana integration^].

==== Amazon EKS console

Use the Amazon EKS Console to see the status of your Kubernetes clusters, applications, and associated cloud resources in one place, as shown in <<aws-eks-console>>.

For information on prerequisites for Amazon EKS Console access configuration, refer to https://docs.aws.amazon.com/eks/latest/userguide/view-workloads.html[View Kubernetes resources^].

:xrefstyle: short
[#aws-eks-console]
.AWS EKS Console
image::../docs/deployment_guide/images/aws-eks-console.png[AWS EKS Console]

=== Exports

After you successfully deploy {partner-product-short-name}, the following AWS Systems Manager (SSM) Parameter Store parameters and AWS Secrets Manager secrets are exposed:

[#ssm1]
.AWS Systems Manager (SSM) Parameter Store parameters
[cols="3,1,2"]
|===
|Name | Type | Description

|/quickstart/gitlab/`{env-name}`/infra/domain-name
|SSM
|{partner-product-short-name} domain name

|/quickstart/gitlab/`{env-name}`/infra/hosted-zone-id
|SSM
|{partner-product-short-name} Route53 hosted zone ID

|/quickstart/gitlab/`{env-name}`/infra/hosted-zone-name
|SSM
|{partner-product-short-name} Route53 hosted zone name

|/quickstart/gitlab/`{env-name}`/cluster/name
|SSM
|EKS cluster name

|/quickstart/gitlab/`{env-name}`/storage/buckets/artifacts
|SSM
|S3 Artifacts bucket name

|/quickstart/gitlab/`{env-name}`/storage/buckets/backup
|SSM
|S3 Backup bucket name

|/quickstart/gitlab/`{env-name}`/storage/buckets/backup-tmp
|SSM
|S3 Backup Temp bucket name

|/quickstart/gitlab/`{env-name}`/storage/buckets/lfs
|SSM
|S3 LFS bucket name

|/quickstart/gitlab/`{env-name}`/storage/buckets/packages
|SSM
|S3 Packages bucket name

|/quickstart/gitlab/`{env-name}`/storage/buckets/pseudonymizer
|SSM
|S3 Pseudonymizer bucket name

|/quickstart/gitlab/`{env-name}`/storage/buckets/registry
|SSM
|S3 Registry bucket name

|/quickstart/gitlab/`{env-name}`/storage/buckets/terraform
|SSM
|S3 Terraform bucket name

|/quickstart/gitlab/`{env-name}`/storage/buckets/uploads
|SSM
|S3 Uploads bucket name

|===

[#secrets1]
.AWS Secrets Manager secrets
[cols="3,1,2"]
|===
|Name | Type | Description

|/quickstart/gitlab/`{env-name}`/infra/smtp-credentials
|Secret
|SMTP server credentials

|/quickstart/gitlab/`{env-name}`/storage/credentials
|Secret
|S3 object storage access credentials

|/quickstart/gitlab/`{env-name}`/secrets/rails
|Secret
|{partner-product-short-name} Rails secret

|/quickstart/gitlab/`{env-name}`/secrets/initial-root-password
|Secret
|{partner-product-short-name} initial root password

|===
