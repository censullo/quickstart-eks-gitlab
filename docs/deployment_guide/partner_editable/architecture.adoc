:xrefstyle: short

Deploying this Quick Start with default parameters builds the following {partner-product-short-name} environment in the AWS Cloud.

// Replace this example diagram with your own. Follow our wiki guidelines: https://w.amazon.com/bin/view/AWS_Quick_Starts/Process_for_PSAs/#HPrepareyourarchitecturediagram. Upload your source PowerPoint file to the GitHub {deployment name}/docs/images/ directory in its repository.

=== Architecture diagram

:xrefstyle: short
[#architecture1]
.Quick Start architecture for {partner-product-short-name} on AWS
image::../docs/deployment_guide/images/architecture_diagram.png[Architecture]

.Key to architecture and best practice compliance tags
[cols="^1,7"]
|===
|Tag|Meaning

|^[AWS-WA]^|Compliant with **AWS W**ell **A**rchitected - including favoring platform&#8209;as&#8209;a&#8209;service (PaaS) to externalize scaling and availability management and high&#8209;availability (HA) / self&#8209;healing for non&#8209;PaaS resources.
|^[GL-RAR]^|Compliant with a **G**it**L**ab **R**eference **A**rchitecture **R**equirement or **R**ecommendation - only applied to items where the reference architectures are opinionated.
|===

The result of this automation is a completely operational {partner-product-short-name} instance.

As shown in <<architecture1>>, the Quick Start sets up the following:

* A highly available architecture that spans two or three Availability Zones. ^[AWS-WA]^
* A VPC configured with public and private subnets, according to AWS best practices, to provide you with your own virtual network on AWS.^1^ ^[AWS-WA]^
* An Amazon Elastic Kubernetes Service (Amazon EKS) cluster, which creates the Kubernetes control plane.^2^ ^[AWS-WA]^
* Multiple Amazon Simple Storage Service (Amazon S3) buckets. See <<Object storage for {partner-product-short-name} storage types>>. ^[GL-RAR][AWS-WA]^
* AWS Secrets Manager secrets for securely storing credentials.
* In the public subnets:
** Managed network address translation (NAT) gateways to allow outbound internet access for resources in the private subnets.^1^
* In the private subnets:
** An Auto Scaling Group of Amazon Elastic Compute Cloud (Amazon EC2) Kubernetes nodes.^2^ ^[AWS-WA]^
** An Amazon Relational Database Service (Amazon RDS) cluster for {partner-product-short-name} and Praefect databases. ^[GL-RAR][AWS-WA]^
** An Amazon ElastiCache: Redis cluster for caching. ^[GL-RAR][AWS-WA]^
** An Amazon S3 object storage PaaS for all non-git file systems and git-lfs ^[GL-RAR][AWS-WA]^
** Elastic Load Balancing (ELB) for external access. ^[AWS-WA]^
** An internal ELB instance for load balancing requests. ^[GL-RAR][AWS-WA]^
** An Auto Scaling Group (ASG) with Gitaly nodes spread across Availability Zones. https://docs.gitlab.com/ee/administration/reference_architectures/10k_users.html#cloud-native-hybrid-reference-architecture-with-helm-charts-alternative[{partner-product-short-name}'s cloud native hybrid reference architecture^] calls for Gitaly to be implemented on Amazon EC2 instance compute and to utilize non-NFS storage for the file system containing Git repositories. ^[GL-RAR][AWS-WA]^
** A Praefect node ASG spread across Availability Zones. https://docs.gitlab.com/ee/administration/reference_architectures/10k_users.html#cloud-native-hybrid-reference-architecture-with-helm-charts-alternative[{partner-product-short-name}'s cloud native hybrid reference architecture^] calls for Praefect to be implemented on Amazon EC2 instance compute. ^[GL-RAR][AWS-WA]^
** Amazon CloudWatch Container Insights integration. ^[AWS-WA]^
** Amazon CloudWatch agent for instance compute. ^[AWS-WA]^
* Optionally (on by default):
** In one public subnet, a Linux bastion host in an Auto Scaling group to allow inbound Secure Shell (SSH) access to Amazon Elastic Compute Cloud (Amazon EC2) instances in private subnets. The bastion host is also configured with the Kubernetes `kubectl` command line interface (CLI) and the `helm` CLI for managing the Kubernetes cluster as well as the AWS CLI for general AWS management. ^[AWS-WA]^
** An Amazon Route 53 hosted zone for DNS name resolution. ^[AWS-WA]^
** An AWS Certificate Manager certificate for TLS traffic encryption. ^[AWS-WA]^
** An Amazon Simple Email Service (Amazon SES) domain for outgoing email messages. ^[AWS-WA]^
** AWS Systems Manager Parameter Store parameters for storing infrastructure as code (IaC) parameters and outputs. ^[AWS-WA]^

[.small]#^1^The template that deploys the Quick Start into an existing VPC skips the components and prompts you for your existing VPC configuration.#

[.small]#^2^The template that deploys the Quick Start into an existing EKS cluster skips the components and prompts you for your existing EKS configuration.#

=== Bundling

==== Bundled provisioning of container registry, backup, log aggregation and monitoring

- Uses Amazon Linux 2 throughout - which benefits from Amazon specific optimizations for performance and compute density for both EKS and EC2 hosts. ^[AWS-WA]^
- All {partner-product-short-name} logs are automatically aggregated into CloudWatch logs via CloudWatch Instance Agent and CloudWatch Container Insights. ^[AWS-WA]^
- EKS workload monitoring via CloudWatch Container Insights. ^[AWS-WA]^
- {partner-product-short-name} backup is preconfigured.
- Prometheus is always deployed with the {partner-product-short-name} instance.
- Setting "ConfigureGrafana" also deploys and configures Grafana. ^[AWS-WA]^
- The container registry is automatically setup at `registry.[subdomain]` ^[AWS-WA]^

=== Security

==== Application secrets

** Stores generated secrets in AWS Secrets Manager (e.g. generates a proper initial root password) ^[AWS-WA]^

==== Amazon EKS cluster administration

The {partner-product-short-name} Kubernetes endpoint can be private, a bastion host must be deployed in order to do direct cluster management (it will be preloaded with AWS, EKS and Kubernetes management utilities and IAM permissions for cluster management). The bastion host is setup with SSH keys, but can also be accessed more securely using AWS Systems Manager (SSM) Session Manager. Additionally, the bastion host has command audit logging enabled and the log is uploaded to CloudWatch Logs.

==== Data encryption

* Data in Transit:
** SSL for front end HTTP. ^[AWS-WA]^
** SSL for {partner-product-short-name} to Amazon S3. ^[AWS-WA]^
** SSL for {partner-product-short-name} to Amazon RDS: PostgreSQL. ^[AWS-WA]^
** SSL for {partner-product-short-name} to Amazon ElastiCache: Redis. ^[AWS-WA]^
** SSL for {partner-product-short-name} to Runner. ^[AWS-WA]^
** SSL not yet available for {partner-product-short-name} to Praefect to Gitaly. ^[AWS-WA]^
* Data at rest (AWS managed keys):
** Amazon S3 Server&#8209;Side encryption ^[AWS-WA]^
** Amazon RDS: PostgreSQL encryption ^[AWS-WA]^
** Amazon ElastiCache: Redis encryption ^[AWS-WA]^
** Amazon Elastic Block Store (Amazon EBS) encryption ^[AWS-WA]^

=== Database

The {partner-product-short-name} Quick Start deploys a highly available (HA) PostgreSQL database cluster using the https://aws.amazon.com/quickstart/architecture/aurora-postgresql/[Amazon Aurora PostgreSQL Quick Start^].

Depending on the projected size of your {partner-product-short-name} deployment you may want to adjust database instance size using *DBInstanceClass* parameter.

There are two databases deployed to the same cluster:

* {partner-product-short-name} database
* Praefect tracking database

Praefect requires a separate tracking database as described in https://docs.gitlab.com/ee/administration/gitaly/praefect.html[Gitaly Cluster documentation^].

For more information about the external database configuration, see the https://docs.gitlab.com/charts/advanced/external-db/[{partner-product-short-name} documentation^].

=== Storage

==== Git repository storage

* Amazon EBS volumes on Gitaly cluster instances. ^[GL-RAR]^

==== Object storage for {partner-product-short-name} storage types

The {partner-product-short-name} Quick Start creates Amazon S3 buckets for the following use cases:

* Artifacts
* https://git-lfs.github.com/[Git large file storage (git-lfs)]
* Uploads
* Packages
* Terraform
* Pseudonymizer
* Registry
* Backup
* Backup temp

If desired, apply S3 policies to these buckets for managing retention, storage tier, and replication.

The contents of each bucket is encrypted by default with Amazon S3 server&#8209;side encryption (SSE-S3). The name of each bucket is auto&#8209;generated and exported as SSM parameters (see the <<Exports>> section).

For more information about external object storage, see the https://docs.gitlab.com/charts/advanced/external-object-storage/[{partner-product-short-name} documentation^].

=== Backups

==== Scheduling backups

The backup schedule is controlled by a cron expression and the default value is `pass:[0 1 * * * *]` (daily at 1am). If desired, you can set a different schedule using the *BackupSchedule* parameter.

==== Content of the backups

Backups include {partner-product-short-name} database snapshots and the contents of {partner-product-short-name} projects, such as Git repositories, wiki pages, et cetera. Backups do *not* include the contents of Amazon S3 buckets (see object storage for a list of buckets). The main reasons behind this decision are:

* Contents of these buckets may be very large (pipeline artifacts, Docker images, etc.) and that may affect stability and performance of the backup jobs.
* Amazon S3 is a https://aws.amazon.com/s3/faqs/#Durability_.26_Data_Protection[durable storage^] option.
* Amazon S3 storage policies also enable out of region replication and management of storage class migration to control costs for older data.

If needed, complete backup may be created using backup-utility as described in https://docs.gitlab.com/charts/backup-restore/[{partner-product-short-name} documentation^].

==== Backup/restore resources

NOTE: The disk volume required for backups is about *2x larger than backup tarball itself*. This is due to the fact that all resources have to be downloaded first and packaged to a tarball file which also stored locally. Consider the size of you {partner-product-short-name} database and projects (mainly Git repositories) to set the size of the underlying EBS volumes appropriately using *BackupVolumeSize* parameter.

In testing, the average size of backups for the default configuration were 20GB, and took about 30 minutes to create and upload to the Amazon S3 bucket.

For large {partner-product-short-name} deployments, you can also adjust the CPU and memory requirements for backup and restore pods using *BackupCpu* and *BackupMemory* parameters.

For more information about backups, see the https://docs.gitlab.com/charts/backup-restore/[{partner-product-short-name} documentation^].

=== Telemetry and monitoring

==== Amazon CloudWatch Container Insights

The {partner-product-short-name} Quick Start integrates the Amazon EKS cluster with https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/ContainerInsights.html[Amazon CloudWatch Container Insights^] to collect, aggregate, and summarize metrics & logs if *ConfigureContainerInsights* parameter is set to `Yes`.

You can access these logs and metrics from the Amazon CloudWatch console:

:xrefstyle: short
[#cloudwatch-container-insights]
.Amazon CloudWatch container insights
image::../docs/deployment_guide/images/cloudwatch-container-insights.png[Amazon CloudWatch Container Insights]

==== Prometheus metrics

{partner-product-short-name} exposes Prometheus metrics under `/-/metrics` of the {partner-product-short-name} Ingress. Optionally, you can also enable a Grafana integration by setting the *ConfigureGrafana* parameter to `Yes`.

:xrefstyle: short
[#grafana]
.Grafana
image::../docs/deployment_guide/images/grafana.png[Grafana]

For more information about the Grafana integration, see the https://docs.gitlab.com/charts/charts/globals.html#configure-grafana-integration[{partner-product-short-name} documentation^].

==== Amazon EKS console

The Amazon EKS Console gives you a single place to see the status of your Kubernetes clusters, applications, and associated cloud resources.

Please see the prerequisites for Amazon EKS Console access configuration in the https://docs.aws.amazon.com/eks/latest/userguide/view-workloads.html[AWS documentation^].

:xrefstyle: short
[#aws-eks-console]
.AWS EKS Console
image::../docs/deployment_guide/images/aws-eks-console.png[AWS EKS Console]

=== Exports

Upon successful {partner-product-short-name} deployment, the following AWS Systems Manager (SSM) parameters and AWS Secrets Manager secrets are exposed:

.SSM parameters
[cols="3,1,2"]
|===
|Name | Type | Description

|/quickstart/gitlab/`{env-name}`/infra/domain-name
|SSM
|{partner-product-short-name} domain name

|/quickstart/gitlab/`{env-name}`/infra/hosted-zone-id
|SSM
|{partner-product-short-name} Route53 hosted zone ID

|/quickstart/gitlab/`{env-name}`/infra/hosted-zone-name
|SSM
|{partner-product-short-name} Route53 hosted zone name

|/quickstart/gitlab/`{env-name}`/cluster/name
|SSM
|EKS Cluster name

|/quickstart/gitlab/`{env-name}`/storage/buckets/artifacts
|SSM
|S3 Artifacts bucket name

|/quickstart/gitlab/`{env-name}`/storage/buckets/backup
|SSM
|S3 Backup bucket name

|/quickstart/gitlab/`{env-name}`/storage/buckets/backup-tmp
|SSM
|S3 Backup Temp bucket name

|/quickstart/gitlab/`{env-name}`/storage/buckets/lfs
|SSM
|S3 LFS bucket name

|/quickstart/gitlab/`{env-name}`/storage/buckets/packages
|SSM
|S3 Packages bucket name

|/quickstart/gitlab/`{env-name}`/storage/buckets/pseudonymizer
|SSM
|S3 Pseudonymizer bucket name

|/quickstart/gitlab/`{env-name}`/storage/buckets/registry
|SSM
|S3 Registry bucket name

|/quickstart/gitlab/`{env-name}`/storage/buckets/terraform
|SSM
|S3 Terraform bucket name

|/quickstart/gitlab/`{env-name}`/storage/buckets/uploads
|SSM
|S3 Uploads bucket name

|===

.Secret Manager secrets
[cols="3,1,2"]
|===
|Name | Type | Description

|quickstart/gitlab/`{env-name}`/infra/smtp-credentials
|Secret
|SMTP server credentials

|/quickstart/gitlab/`{env-name}`/storage/credentials
|Secret
|S3 object storage access credentials

|/quickstart/gitlab/`{env-name}`/secrets/rails
|Secret
|{partner-product-short-name} Rails secret

|/quickstart/gitlab/`{env-name}`/secrets/initial-root-password
|Secret
|{partner-product-short-name} initial root password

|===
